<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Enhanced Brand Detection - Reformation Dress</title>
</head>
<body>
    <h1>Reformation Dress - Test Page</h1>
    <p>This is a test page to verify enhanced brand detection.</p>
    <p>Product: Reformation Silk Dress</p>
    
    <script>
        // Simulate the enhanced brand detection logic
        function extractDomain(url) {
            try {
                const urlObj = new URL(url);
                return urlObj.hostname.replace('www.', '');
            } catch (error) {
                return 'Unknown';
            }
        }

        function normalizeBrandName(brandName) {
            if (!brandName) return '';
            
            let normalized = brandName.trim();
            
            // Common variations and abbreviations
            const brandVariations = {
                'ganni': 'GANNI',
                'thereformation': 'Reformation',
                'the reformation': 'Reformation',
                '& other stories': 'And Other Stories',
                'and other stories': 'And Other Stories',
                'other stories': 'And Other Stories',
                'abercrombie': 'Abercrombie & Fitch',
                'abercrombie & fitch': 'Abercrombie & Fitch',
                'a&f': 'Abercrombie & Fitch',
                'levis': 'Levi\'s',
                'levi\'s': 'Levi\'s',
                'levi': 'Levi\'s',
                'mother': 'MOTHER',
                'mother denim': 'MOTHER',
                'st agni': 'St. Agni',
                'st. agni': 'St. Agni',
                'le monde beryl': 'Le Monde Beryl',
                'lemondeberyl': 'Le Monde Beryl',
                'jamie haller': 'Jamie Haller',
                'jamiehaller': 'Jamie Haller',
                'frank & eileen': 'Frank & Eileen',
                'frankandeileen': 'Frank & Eileen',
                'with nothing underneath': 'With Nothing Underneath',
                'withnothingunderneath': 'With Nothing Underneath',
                'jenni kayne': 'Jenni Kayne',
                'jennikayne': 'Jenni Kayne',
                'rejina pyo': 'Rejina Pyo',
                'rejinapyo': 'Rejina Pyo',
                'vibi venezia': 'Vibi Venezia',
                'vibivenezia': 'Vibi Venezia',
                'le bon shoppe': 'Le Bon Shoppe',
                'lebon-shoppe': 'Le Bon Shoppe',
                'lebon shoppe': 'Le Bon Shoppe',
                'emme parsons': 'Emme Parsons',
                'emmeparsons': 'Emme Parsons',
                'ancient greek sandals': 'Ancient Greek Sandals',
                'ancientgreeksandals': 'Ancient Greek Sandals',
                'a. emery': 'A. Emery',
                'aemery': 'A. Emery',
                'ben-amun': 'Ben-Amun',
                'ben amun': 'Ben-Amun',
                'benamun': 'Ben-Amun',
                'shopdonni': 'Donni',
                'donni': 'Donni'
            };
            
            // Check for exact matches in variations
            const lowerBrand = normalized.toLowerCase();
            if (brandVariations[lowerBrand]) {
                return brandVariations[lowerBrand];
            }
            
            // Check for partial matches
            for (const [variation, standardName] of Object.entries(brandVariations)) {
                if (lowerBrand.includes(variation) || variation.includes(lowerBrand)) {
                    return standardName;
                }
            }
            
            return normalized;
        }

        function extractItemName(title, url) {
            // Try to extract item name from page title first
            if (title && title.trim()) {
                // Remove common website suffixes and clean up
                let cleanTitle = title.trim();
                
                // Remove common website name patterns
                cleanTitle = cleanTitle.replace(/\s*[-|]\s*(Reformation|GANNI|ASOS|And Other Stories|Intimissimi|Zara|H&M|Mango|Uniqlo|COS|Arket|Massimo Dutti|Bershka|Pull&Bear|Stradivarius|Urban Outfitters|Anthropologie|Free People|Madewell|Everlane|Revolve|Shopbop|Nordstrom|Bloomingdale's|Saks Fifth Avenue|Neiman Marcus|Bergdorf Goodman|Barneys|Net-a-Porter|Matches Fashion|Farfetch|SSENSE|Lyst|The RealReal|Poshmark|Depop|Vestiaire Collective|Grailed|StockX|GOAT|Flight Club|Stadium Goods)\s*$/i, '');
                
                // Remove common separators and clean up
                cleanTitle = cleanTitle.replace(/\s*[-|]\s*$/, '');
                cleanTitle = cleanTitle.replace(/^\s*[-|]\s*/, '');
                
                // Remove common product page suffixes
                cleanTitle = cleanTitle.replace(/\s*(Buy|Shop|Purchase|Order|Add to Cart|Add to Bag|View|Details|Product|Item)\s*$/i, '');
                
                // Remove common size/color indicators that might be in titles
                cleanTitle = cleanTitle.replace(/\s*(XS|S|M|L|XL|XXL|0|2|4|6|8|10|12|14|16|18|20|22|24|26|28|30|32|34|36|38|40|42|44|46|48|50)\s*$/i, '');
                cleanTitle = cleanTitle.replace(/\s*(Black|White|Blue|Red|Green|Yellow|Pink|Purple|Orange|Brown|Gray|Grey|Navy|Beige|Cream|Ivory|Tan|Olive|Maroon|Burgundy|Rust|Coral|Teal|Turquoise|Lavender|Mint|Rose|Gold|Silver|Bronze|Copper)\s*$/i, '');
                
                // Clean up extra whitespace
                cleanTitle = cleanTitle.replace(/\s+/g, ' ').trim();
                
                if (cleanTitle.length > 3 && cleanTitle.length < 200) {
                    return cleanTitle;
                }
            }
            
            // Fallback: try to extract from URL path
            try {
                const urlObj = new URL(url);
                const pathParts = urlObj.pathname.split('/').filter(part => part.length > 0);
                
                // Look for meaningful path segments (skip common words)
                const meaningfulParts = pathParts.filter(part => 
                    part.length > 2 && 
                    !['product', 'item', 'clothing', 'dress', 'shirt', 'pants', 'shoes', 'accessories', 'women', 'men', 'kids', 'sale', 'new', 'trending'].includes(part.toLowerCase())
                );
                
                if (meaningfulParts.length > 0) {
                    // Take the last meaningful part and clean it up
                    let urlItemName = meaningfulParts[meaningfulParts.length - 1];
                    urlItemName = urlItemName.replace(/[-_]/g, ' ').replace(/\s+/g, ' ').trim();
                    
                    // Remove common URL suffixes
                    urlItemName = urlItemName.replace(/\s*(html|htm|php|asp|aspx|jsp|do|action)\s*$/i, '');
                    
                    if (urlItemName.length > 3 && urlItemName.length < 100) {
                        return urlItemName;
                    }
                }
            } catch (error) {
                // URL parsing failed, continue to fallback
            }
            
            // Final fallback
            return 'Unknown Item';
        }

        function detectBrand(url, itemName) {
            // First, try to extract brand from URL
            const domain = extractDomain(url);
            
            // Common brand mappings from domains - using exact database names
            const domainBrands = {
                'asos.com': 'ASOS',
                'zara.com': 'Zara',
                'hm.com': 'H&M',
                'uniqlo.com': 'Uniqlo',
                'cos.com': 'COS',
                'arket.com': 'Arket',
                'ganni.com': 'GANNI',
                'intimissimi.com': 'Intimissimi',
                'mango.com': 'Mango',
                'massimodutti.com': 'Massimo Dutti',
                'stories.com': 'And Other Stories',
                'weekday.com': 'Weekday',
                'monki.com': 'Monki',
                'bershka.com': 'Bershka',
                'pullandbear.com': 'Pull&Bear',
                'thereformation.com': 'Reformation',
                'reformation.com': 'Reformation',
                'sezane.com': 'Sezane',
                'madewell.com': 'Madewell',
                'everlane.com': 'Everlane',
                'quince.com': 'Quince',
                'dissh.com': 'Dissh',
                'posse.com': 'Posse',
                'abercrombie.com': 'Abercrombie & Fitch',
                'toteme.com': 'Toteme',
                'khaite.com': 'Khaite',
                'aminamuaddi.com': 'Amina Muaddi',
                'levis.com': 'Levi\'s',
                'lemondeberyl.com': 'Le Monde Beryl',
                'jamiehaller.com': 'Jamie Haller',
                'motherdenim.com': 'MOTHER',
                'thefrankieshop.com': 'The Frankie Shop',
                'withnothingunderneath.com': 'With Nothing Underneath',
                'jennikayne.com': 'Jenni Kayne',
                'vollebak.com': 'Vollebak',
                'frankandeileen.com': 'Frank & Eileen',
                'rejinapyo.com': 'Rejina Pyo',
                'vibivenezia.com': 'Vibi Venezia',
                'stagni.com': 'St. Agni',
                'lebon-shoppe.com': 'Le Bon Shoppe',
                'doen.com': 'Doen',
                'emmeparsons.com': 'Emme Parsons',
                'ancientgreeksandals.com': 'Ancient Greek Sandals',
                'leset.com': 'Leset',
                'aemery.com': 'A. Emery',
                'ben-amun.com': 'Ben-Amun',
                'maje.com': 'Maje',
                'paige.com': 'Paige',
                'shopdonni.com': 'Donni',
                'donni.com': 'Donni',
                // Additional brands from the original content script
                'warehouse.com': 'Warehouse',
                'oasis.com': 'Oasis',
                'whistles.com': 'Whistles',
                'reiss.com': 'Reiss',
                'tedbaker.com': 'Ted Baker',
                'karenmillen.com': 'Karen Millen',
                'coast.com': 'Coast',
                'monsoon.com': 'Monsoon',
                'accessorize.com': 'Accessorize',
                'dorothyperkins.com': 'Dorothy Perkins',
                'evans.com': 'Evans',
                'wallis.com': 'Wallis',
                'burton.com': 'Burton',
                'topman.com': 'Topman',
                'topshop.com': 'Topshop',
                'riverisland.com': 'River Island',
                'newlook.com': 'New Look',
                'boohoo.com': 'Boohoo',
                'prettylittlething.com': 'Pretty Little Thing',
                'missguided.com': 'Missguided',
                'nastygal.com': 'Nasty Gal',
                'netaporter.com': 'Net-a-Porter',
                'matchesfashion.com': 'Matches Fashion',
                'farfetch.com': 'Farfetch',
                'ssense.com': 'SSENSE',
                'selfridges.com': 'Selfridges',
                'harrods.com': 'Harrods',
                'libertylondon.com': 'Liberty London',
                'johnlewis.com': 'John Lewis',
                'debenhams.com': 'Debenhams',
                'houseoffraser.com': 'House of Fraser',
                'marksandspencer.com': 'Marks & Spencer',
                'next.co.uk': 'Next',
                'coach.com': 'Coach',
                'katespade.com': 'Kate Spade',
                'michaelkors.com': 'Michael Kors',
                'longchamp.com': 'Longchamp',
                'nike.com': 'Nike',
                'adidas.com': 'Adidas',
                'converse.com': 'Converse',
                'vans.com': 'Vans',
                'drmartens.com': 'Dr. Martens',
                'clarks.com': 'Clarks',
                'timberland.com': 'Timberland',
                'rolex.com': 'Rolex',
                'omega.com': 'Omega',
                'cartier.com': 'Cartier'
            };

            // Check if we have a direct domain match
            if (domainBrands[domain]) {
                return domainBrands[domain];
            }

            // Handle "the" prefix domains more intelligently
            if (domain.startsWith('the') && domain.length > 3) {
                const brandWithoutThe = domain.substring(3); // Remove "the" prefix
                const brandWithCom = brandWithoutThe + '.com';
                if (domainBrands[brandWithCom]) {
                    return domainBrands[brandWithCom];
                }
            }

            // If no direct match, try to extract brand from item name
            if (itemName) {
                // Common brand patterns in product names - updated with actual database names
                const brandPatterns = [
                    /^(ASOS|Zara|H&M|Uniqlo|COS|Arket|GANNI|Intimissimi|Mango|Massimo Dutti|And Other Stories|Weekday|Monki|Bershka|Pull&Bear|Reformation|Sezane|Madewell|Everlane|Quince|Dissh|Posse|Abercrombie & Fitch|Toteme|Khaite|Amina Muaddi|Levi's|Le Monde Beryl|Jamie Haller|MOTHER|The Frankie Shop|With Nothing Underneath|Jenni Kayne|Vollebak|Frank & Eileen|Rejina Pyo|Vibi Venezia|St\. Agni|Le Bon Shoppe|Doen|Emme Parsons|Ancient Greek Sandals|Leset|A\. Emery|Ben-Amun|Maje|Paige)/i,
                    /by\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)/i,
                    /from\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)/i
                ];

                for (const pattern of brandPatterns) {
                    const match = itemName.match(pattern);
                    if (match) {
                        const detectedBrand = match[1] || match[0];
                        return normalizeBrandName(detectedBrand);
                    }
                }
            }

            // Fallback: try to extract from domain (remove .com, capitalize)
            if (domain && domain !== 'Unknown') {
                let domainBrand = domain.split('.')[0];
                
                // Handle common domain patterns
                if (domainBrand.includes('-')) {
                    // Split by hyphens and capitalize
                    domainBrand = domainBrand.split('-')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                } else if (domainBrand.length > 6) {
                    // Try to intelligently split camelCase or run-together words
                    // Look for common brand patterns
                    const commonBrands = [
                        'waxlondon', 'roheframes', 'ganni', 'reformation', 'madewell',
                        'everlane', 'sezane', 'toteme', 'khaite', 'motherdenim'
                    ];
                    
                    const lowerDomain = domainBrand.toLowerCase();
                    for (const brand of commonBrands) {
                        if (lowerDomain.includes(brand)) {
                            // Extract the brand part and format it properly
                            const brandIndex = lowerDomain.indexOf(brand);
                            const beforeBrand = domainBrand.substring(0, brandIndex);
                            const brandPart = domainBrand.substring(brandIndex, brandIndex + brand.length);
                            const afterBrand = domainBrand.substring(brandIndex + brand.length);
                            
                            // Format each part
                            const formattedBrand = brandPart.charAt(0).toUpperCase() + brandPart.slice(1);
                            const formattedBefore = beforeBrand ? beforeBrand.charAt(0).toUpperCase() + beforeBrand.slice(1) + ' ' : '';
                            const formattedAfter = afterBrand ? ' ' + afterBrand.charAt(0).toUpperCase() + afterBrand.slice(1) : '';
                            
                            domainBrand = formattedBefore + formattedBrand + formattedAfter;
                            break;
                        }
                    }
                    
                    // If no pattern match, try to add spaces before capital letters (camelCase)
                    if (domainBrand === domain.split('.')[0]) {
                        domainBrand = domainBrand.replace(/([A-Z])/g, ' $1').trim();
                        domainBrand = domainBrand.charAt(0).toUpperCase() + domainBrand.slice(1);
                    }
                }
                
                console.log('🔍 Domain brand extraction:', { original: domain, extracted: domainBrand });
                return normalizeBrandName(domainBrand);
            }

            return 'Unknown Brand';
        }

        function extractBrandFromContext() {
            try {
                console.log('🎯 FashionWidget: Analyzing website and extracting brand with enhanced detection...');
                
                const url = window.location.href;
                const title = document.title;
                
                // Extract domain and item name
                const domain = extractDomain(url);
                const itemName = extractItemName(title, url);
                
                console.log('🎯 FashionWidget: Domain:', domain, 'Item name:', itemName);
                
                // Use the sophisticated brand detection logic
                const brandName = detectBrand(url, itemName);
                const normalizedBrand = normalizeBrandName(brandName);
                
                console.log('🎯 FashionWidget: Detected brand:', brandName, 'Normalized:', normalizedBrand);
                
                // Only return if we have a valid brand (not 'Unknown Brand')
                if (normalizedBrand && normalizedBrand !== 'Unknown Brand') {
                    return normalizedBrand;
                }
                
                console.log('🎯 FashionWidget: No valid brand detected');
                return null;
                
            } catch (error) {
                console.error('🎯 FashionWidget: Error in enhanced brand detection:', error);
                return null;
            }
        }

        // Test the enhanced brand detection
        console.log('🧪 Testing Enhanced Brand Detection...');
        const detectedBrand = extractBrandFromContext();
        console.log('✅ Final Result:', detectedBrand);
        
        // Display results on page
        document.body.innerHTML += `
            <div style="margin-top: 20px; padding: 20px; background: #f0f0f0; border-radius: 8px;">
                <h2>Test Results</h2>
                <p><strong>Detected Brand:</strong> ${detectedBrand || 'None'}</p>
                <p><strong>Page Title:</strong> ${document.title}</p>
                <p><strong>Current URL:</strong> ${window.location.href}</p>
                <p><strong>Domain:</strong> ${extractDomain(window.location.href)}</p>
                <p><strong>Item Name:</strong> ${extractItemName(document.title, window.location.href)}</p>
            </div>
        `;
    </script>
</body>
</html>
